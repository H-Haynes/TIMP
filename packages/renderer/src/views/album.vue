<template>
  <div  class="px-8 flex flex-col h-full overflow-y-scroll"  v-loading.lock="loading" element-loading-background="rgba(0,0,0,.7)">
    <div class="h-16 w-full flex-shrink-0"></div>
    <div class="flex-1 overflow-y-scroll">
      <div class="flex h-40 overflow-hidden">
        <el-image
          :src="albumInfo.coverImg || poster"
          class="w-40 h-40 rounded flex-shrink-0"
        />
        <div class="ml-4 text-gray-300 text-xl text-left flex flex-col">
          <strong>{{ albumInfo.name || albumInfo.title }}</strong>
          <div class="text-gray-400 flex mt-2 justify-between items-center text-xs">
            <div class="flex items-center ">
              <el-avatar
                :size="16"
                :src="albumInfo?.creator?.avatar"
              />
              <span class="text-sm ml-2 text-blue-300">{{ albumInfo.creator?.nickname }}</span>
            </div>
            <p>最近更新：{{ $filters.timeFormat(albumInfo.updateTime) }}</p>
          </div>
          <p
            class="text-xs text-left overflow-y-scroll leading-5 mt-2"
            vue
            no-v-html
            v-html="albumInfo.description ?albumInfo.description.replace(/\n/g,'<br/>') : '' "
          />
          <div class="mt-2 text-xs flex">
            <span class="w-24 cursor-pointer bg-red-700 flex items-center justify-center hover:bg-red-600 leading-6 mr-3 rounded-xl">
              <i class="iconfont icon-botany2 mr-1" />
              播放全部
            </span>
            <span @click="addCollect" class="w-24 flex items-center justify-center cursor-pointer hover:bg-gray-600 bg-gray-700 leading-6 mr-3 rounded-xl">
              <i class="iconfont icon-icon-xian-" />
              {{myCollect.some(ele=>ele.id == albumId) ? '取消收藏' :'收藏'}}
            </span>
            <span class="w-24 flex items-center justify-center cursor-pointer leading-6 mr-3 rounded-xl border border-gray-500 hover:border-gray-400">
              <i class="iconfont icon-download" />
              下载全部
            </span>
          </div>
        </div>
      </div>
      <el-table
        class="mt-8"
        stripe
        cell-class-name="bg-primary-100 cursor-pointer" 
        :header-cell-style="{backgroundColor: '#212121 !important'}"
        :data="songList"
        @row-dblclick="playSong"
        :key="albumId"
      >
        <el-table-column
          label="歌曲"
          prop="name"
          class="whitespace-nowrap"
        >
          <template #default="scope">
            <el-tooltip :content="scope.row.name">
              <span class="whitespace-nowrap">{{ scope.row.name }}</span>
            </el-tooltip>
            <i
              v-if="scope.row.mv"
              @click="playMv(scope.row.mv,scope.row.type)"
              class="iconfont ml-2 icon-mv cursor-pointer text-red-500"
            />
          </template>
        </el-table-column>
        <el-table-column
          label="歌手"
          class="truncate"
        >
          <template #default="scope">
            <span>{{scope.row.art?.reduce((prev,cur)=> prev + (prev ? '/'+cur.name : cur.name),'')}}</span>
          </template>
        </el-table-column>
        <el-table-column label="专辑">
          <template #default="scope">
            <el-tooltip :content="scope.row.album">
              <span class="whitespace-nowrap overflow-hidden">{{ scope.row.album }}</span>
            </el-tooltip>
          </template>
        </el-table-column>
        <el-table-column
          label="时长"
          prop="name"
          width="100"
        >
          <template #default="scope">
            {{ $filters.durationFormat(scope.row.time) }}
          </template>
        </el-table-column>
        <el-table-column label="操作">
          <template #default="scope">
            <i @click="addLike(scope.row)" class="iconfont icon-xihuan cursor-pointer ml-2" v-if="!likeList.some(ele=>ele.id === scope.row.id)"></i>
            <i @click="unLike(scope.row.id)" class="iconfont text-red-500 cursor-pointer icon-chuangyikongjianICON_fuzhi- ml-2" v-else/>
            <i class="iconfont icon-icon-xian- cursor-pointer ml-2" />
            <i class="iconfont icon-delete cursor-pointer ml-2" v-show="albumId==0"/>
          </template>
        </el-table-column>
        <template #empty>
          <div class="bg-primary-200 w-full h-80 flex justify-center items-center flex-col">
              <i class="iconfont icon-zanwushuju text-7xl" />
             <span class="text-gray-500">没有数据</span>
          </div>
         
        </template>
      </el-table>
    </div>
  </div>    
</template>
<script lang="ts" setup>
import { ref, watchEffect, inject,toRaw, } from 'vue';
import { getAlbumDetailWy } from '../api/netease';
import {getAlbumDetailQQ, getRankDetailQQ} from '../api/qq';
import { useRoute,useRouter } from 'vue-router';
import poster from '@/../assets/poster.jpg';
const $filters = inject('$filters');
const $eventBus:any = inject('$eventBus');
const loading = ref(false);
const route = useRoute();
const router = useRouter();
const albumId = ref(route.query.id);
const albumInfo = ref({
  name: '',
  id: '',
  description: '',
  subscribedCount: 0,
  trackCount: 0,
  coverImg: '',
  createTime: 0,
  updateTime: 0,
  creator: {
    avatar: '',
    desc: '',
    nickname: '',
  },
});
const songList = ref([]);
const platform = ref(+route.query.type);
const likeList = inject('likeList');
const likeAlbum = inject('likeAlbum');
const myCollect = inject('myCollect');
// if(platform.value == 0 && ){
  
// }

const getWyAlbum = async(id:string) =>{
  const res = await getAlbumDetailWy(id);
  if(res.data.code === 200){
    const {name,id,description,subscribedCount,trackCount,coverImgUrl: coverImg,createTime,trackUpdateTime:updateTime,} = res.data.playlist;
    const {avatarUrl: avatar,description: desc,nickname,} = res.data.playlist.creator;
    albumInfo.value = {name,id,description,subscribedCount,trackCount,coverImg,createTime,updateTime,creator: {avatar,desc,nickname,},};
    songList.value = res.data.playlist.tracks.map((ele:any)=>{
          return {name:ele.name,id:ele.id,mv:ele.mv,time:ele.dt,album:ele.al.name,picUrl:ele.al.picUrl,
              art:ele.ar.map((el:any)=>{
                  return {
                      name:el.name,
                      id:el.id,
                  };
              }),
              
          };
    });
  }
};

const getQQAlbum = async(id:string) => {
  const result = await getAlbumDetailQQ(id);
  if(result.data.response.code === 0){
    let {dissname:name,dissid:id,desc:description,visitnum:subscribedCount,cmtnum:trackCount,logo: coverImg,ctime:createTime,ctime:updateTime,headurl:avatar,nick:desc,nickname} = result.data.response.cdlist[0];
    updateTime *= 1000;
    albumInfo.value = {name,id,description,subscribedCount,trackCount,coverImg,createTime,updateTime,creator: {avatar,desc,nickname,},};
    songList.value = result.data.response.cdlist[0].songlist.map((ele:any)=>{
        return {name:ele.name,id:ele.mid,mv:ele.mv.vid || undefined,time:ele.interval * 1000,album:ele.album.name,picUrl:ele.album.picUrl,
            art:ele.singer.map((el:any)=>{
                return {
                    name:el.name,
                    id:el.id,
                };
            }),
            
        };
    });
  }
};

const getQQRankDetail = async(id:number) => {
  const result = await getRankDetailQQ(id);
  console.log(result);
  if(result.data.response.code === 0){
    let {title:name,topId:id,titleShare:description,listenNum:subscribedCount,listenNum:trackCount,frontPicUrl: coverImg,updateTime:createTime,updateTime:updateTime,topAlbumURL:avatar,AdShareContent:desc,AdShareContent:nickname} = result.data.response.req_1.data.data;
    albumInfo.value = {name,id,description,subscribedCount,trackCount,coverImg,createTime,updateTime,creator: {avatar,desc,nickname,},};
    let list = [];
    if(result.data.response.req_1.data.songInfoList.length>0){
      list = result.data.response.req_1.data.songInfoList.map(ele=>({
            name:ele.name,
            id:ele.mid,
            mv:ele.mv.vid || undefined,
            time:ele.interval * 1000,
            album:ele.album.name,
            picUrl:ele.album.picUrl,
            art:ele.singer.map((el:any)=>{
                return {
                    name:el.name,
                    id:el.id,
                };
            }),
            
      }));
    }else{
      list = result.data.response.req_1.data.data.song.map(ele=>({
            name:ele.title,
            id:ele.songId,
            albumMid:ele.albumMid,
            mv:ele.vid || undefined,
            time:null,
            album:'-',
            picUrl:ele.cover,
            art:[{
              name:ele.singerName,
              id:ele.singerMid,
            }],
      }));
    }
    songList.value = list;
  }
};

watchEffect(async() => {
  loading.value = true;
  if(albumId.value == 0){
    albumInfo.value = likeAlbum;
    // console.log(likeList);
    songList.value = likeList.value;
  }else if (route.query.type && +route.query.type == 1) {
    await getWyAlbum(route.query.id as string);
  }else if(route.query.type && +route.query.type == 2){
    if(!route.query.isRank){
      await getQQAlbum(route.query.id as string);
    }else{
      await getQQRankDetail(+(route.query.id as unknown as number));
    }
  }
  loading.value = false;
});
const playSong = (song:any) => {
    $eventBus.emit('playSong',{
      id:song.id,
      type:song.type || platform.value,
    });
};

const playMv = (id:any,type) => {
    router.push({
      path:'/video/player',
      query:{
        id,
        type:type ||  platform.value,
      },
    });
};

const addLike = (song:any) => {
  let info = toRaw(song);
  info.type = platform.value;
  $eventBus.emit('addLike',info);
};

const unLike = (id:string) => {
  $eventBus.emit('unLike',id);
};

const addCollect = () => {
  if(myCollect.value.some(ele=>ele.id == albumId.value)){
    $eventBus.emit('unCollect',albumId.value);
  }else{
      $eventBus.emit('addCollect',{
        id:albumId.value,
        type:platform.value,
        name:albumInfo.value.name,
      });
  }

};

</script>
<style lang="less">
.el-table__row--striped {
    background-color:#212121 !important;
    td{
        background-color:#212121 !important;
    }
}

.el-table__empty-text{
  width:100%;
}
.el-table__inner-wrapper::before{
  background:none;
}
</style>